<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CÃ¢mera Natural ðŸ’•</title>
<style>
  body {margin:0; background:#000; overflow:hidden; height:100vh; display:flex; justify-content:center; align-items:center;}
  video, canvas#gl {position:absolute; top:0; left:0; width:100vw; height:100vh; object-fit:cover;}
  canvas#gl {background:#000;}

  #controls {position:absolute; bottom:50px; width:100%; display:flex; justify-content:center; align-items:center;}
  #recordButton {width:90px; height:90px; border-radius:50%; border:6px solid white; background:red; box-shadow:0 0 10px rgba(255,0,0,0.7); cursor:pointer; transition:transform .15s, box-shadow .3s;}
  #recordButton:active {transform:scale(.9); box-shadow:0 0 25px rgba(255,0,0,1);}

  #photoButton {position:absolute; right:80px; bottom:85px; width:70px; height:70px; border-radius:50%; border:5px solid white; background:white; display:flex; align-items:center; justify-content:center; cursor:pointer;}
  #photoButton svg {width:38px; height:38px; fill:black;}

  #switch {position:absolute; top:20px; right:20px; background:transparent; border:none; width:75px; height:75px; display:flex; align-items:center; justify-content:center; cursor:pointer;}
  #switch svg {width:55px; height:55px; fill:white; opacity:.95; filter: drop-shadow(0 0 12px rgba(255,255,255,0.9)) drop-shadow(0 0 25px rgba(255,255,255,0.7)); animation: brilho 2s infinite ease-in-out;}
  @keyframes brilho {0%,100%{filter:drop-shadow(0 0 10px rgba(255,255,255,0.7)) drop-shadow(0 0 20px rgba(255,255,255,0.5));}50%{filter:drop-shadow(0 0 25px rgba(255,255,255,1)) drop-shadow(0 0 40px rgba(255,255,255,0.9));}}

  #previewContainer {display:none; position:absolute; top:0; left:0; width:100vw; height:100vh; background:#000; justify-content:center; align-items:center; z-index:1000; flex-direction:column;}
  #previewVideo, #previewImage {max-width:100vw; max-height:100vh; object-fit:contain;}

  #frozenFrame {
    display:none; position:absolute; top:0; left:0; width:100vw; height:100vh;
    object-fit:cover; z-index:900; filter: blur(12px) brightness(0.9); transform: scale(1.05);
  }

  #tapPlay {
    display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:120px; height:120px; z-index:950; animation:pulse 1.2s infinite ease-in-out;
    cursor:pointer; filter:drop-shadow(0 0 25px rgba(255,255,255,0.9));
  }
  @keyframes pulse {0%,100%{opacity:0.4; transform:translate(-50%,-50%) scale(1);}50%{opacity:1; transform:translate(-50%,-50%) scale(1.12);} }

  #previewActions {position:absolute; bottom:130px; display:flex; flex-direction:column; align-items:center; gap:12px;}
  .btnShare {background:#ff4da6; color:white; font-size:18px; border:none; border-radius:25px; padding:10px 30px; font-weight:bold; box-shadow:0 0 20px rgba(255,77,166,0.9); cursor:pointer;}
  .btnClose {background:rgba(0,0,0,0.75); color:white; font-size:16px; border:1.5px solid rgba(255,255,255,0.4); border-radius:25px; padding:8px 25px; cursor:pointer;}
</style>
</head>
<body>
<video id="video" playsinline autoplay muted style="display:none"></video>
<canvas id="gl"></canvas>

<div id="controls">
  <button id="recordButton"></button>
</div>

<button id="photoButton">
  <svg viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="3.2"></circle>
    <path d="M20 5h-3.2l-1.8-2H9L7.2 5H4C2.9 5 2 5.9 2 7v12c0 
    1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 
    14H4V7h3.05l1.83-2h6.24l1.83 2H20v12z"></path>
  </svg>
</button>

<button id="switch">
  <svg viewBox="0 0 512 512">
    <path d="M256 96c-88.22 0-160 71.78-160 160H64l64 64 64-64h-32c0-70.58 
    57.42-128 128-128 31.35 0 60.02 11.48 82.41 30.4l23.18-27.08C364.94 
    107.51 312.92 96 256 96zm128 160c0 70.58-57.42 128-128 128-31.35 
    0-60.02-11.48-82.41-30.4l-23.18 27.08C147.06 404.49 199.08 416 
    256 416c88.22 0 160-71.78 160-160h32l-64-64-64 64h32z"/>
  </svg>
</button>

<div id="previewContainer">
  <img id="frozenFrame">
  <video id="previewVideo" playsinline muted style="display:none;"></video>
  <img id="tapPlay" src="https://uploads.onecompiler.io/43zxswfqg/43zy78n39/m011t0447_h_social_sign_18sep22.png" alt="Play">
  <img id="previewImage" style="display:none;">
  <div id="previewActions">
    <button id="shareBtn" class="btnShare">Compartilhar ðŸ’•</button>
    <button id="closeBtn" class="btnClose">Fechar</button>
  </div>
</div>

<script>
let currentFacing="environment", stream, isRecording=false, mediaRecorder, recordedChunks=[];
let firstPreview=false;
const v=document.getElementById("video");
const glcanvas=document.getElementById("gl");
const gl=glcanvas.getContext("webgl",{preserveDrawingBuffer:true});
const recordButton=document.getElementById("recordButton");
const photoButton=document.getElementById("photoButton");
const preview=document.getElementById("previewContainer");
const previewImg=document.getElementById("previewImage");
const previewVid=document.getElementById("previewVideo");
const frozenFrame=document.getElementById("frozenFrame");
const tapPlay=document.getElementById("tapPlay");
const shareBtn=document.getElementById("shareBtn");
const closeBtn=document.getElementById("closeBtn");

function createShader(type,src){const s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); return s;}
const vs=createShader(gl.VERTEX_SHADER,`attribute vec2 p; varying vec2 uv;
void main(){ uv=(p+1.0)/2.0; uv.y=1.0-uv.y; gl_Position=vec4(p,0,1); }`);
const fs=createShader(gl.FRAGMENT_SHADER,`precision mediump float; varying vec2 uv;
uniform sampler2D t; uniform bool flipX;
void main(){ vec2 texCoord=uv; if(flipX) texCoord.x=1.0-texCoord.x;
gl_FragColor=texture2D(t,texCoord); }`);
const prog=gl.createProgram(); gl.attachShader(prog,vs); gl.attachShader(prog,fs); gl.linkProgram(prog);
const buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);
gl.useProgram(prog);
const loc=gl.getAttribLocation(prog,"p"); gl.enableVertexAttribArray(loc);
gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
const tex=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,tex);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
gl.uniform1i(gl.getUniformLocation(prog,"t"),0);
const flipLoc=gl.getUniformLocation(prog,"flipX");

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  const constraints={audio:true, video:{facingMode:currentFacing, width:{ideal:1920}, height:{ideal:1080}}};
  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    v.srcObject=stream; await v.play();
    renderLoop();
  } catch(e) { console.error(e); }
}

function renderLoop(){
  if(v.videoWidth===0){ requestAnimationFrame(renderLoop); return;}
  glcanvas.width=innerWidth; glcanvas.height=innerHeight;
  gl.viewport(0,0,glcanvas.width,glcanvas.height);
  gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,v);
  gl.uniform1i(flipLoc, currentFacing==="user");
  gl.drawArrays(gl.TRIANGLES,0,6);
  requestAnimationFrame(renderLoop);
}

photoButton.onclick = () => {
  const data = glcanvas.toDataURL("image/png");
  previewImg.src = data;
  previewImg.style.display="block";
  previewVid.style.display="none";
  preview.style.display="flex";
};

recordButton.onmousedown=startRec;
recordButton.onmouseup=stopRec;
recordButton.ontouchstart=e=>{e.preventDefault();startRec();};
recordButton.ontouchend=e=>{e.preventDefault();stopRec();};

function startRec(){
  if(isRecording)return;
  recordedChunks=[];
  const mime = MediaRecorder.isTypeSupported("video/mp4") ? "video/mp4" : "video/webm";
  mediaRecorder=new MediaRecorder(glcanvas.captureStream(),{mimeType:mime});
  mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data);};
  mediaRecorder.onstop=()=>{
    const blob=new Blob(recordedChunks,{type:mime});
    const url=URL.createObjectURL(blob);
    previewVid.src=url; previewVid.style.display="block"; previewImg.style.display="none";
    preview.style.display="flex"; previewVid.muted=false;
    previewVid.onended=()=>previewVid.play();

    glcanvas.toBlob(b=>{
      const imgURL=URL.createObjectURL(b);
      frozenFrame.src=imgURL;
    },"image/png");

    if(!firstPreview){
      frozenFrame.style.display="block"; tapPlay.style.display="block";
      const handle=()=>{
        frozenFrame.style.display="none";tapPlay.style.display="none";
        previewVid.play().catch(()=>{}); firstPreview=true;
        previewVid.onended=()=>previewVid.play();
        preview.removeEventListener("touchstart",handle);
      };
      preview.addEventListener("touchstart",handle);
    } else {
      frozenFrame.style.display="none"; tapPlay.style.display="none"; previewVid.play();
    }
  };
  mediaRecorder.start();
  isRecording=true; recordButton.style.background="darkred";
}
function stopRec(){
  if(!isRecording)return;
  mediaRecorder.stop(); isRecording=false; recordButton.style.background="red";
}

shareBtn.onclick=async()=>{
  try{
    let blob,fileName,mimeType;
    if(previewImg.style.display==="block"){
      blob=await (await fetch(previewImg.src)).blob();
      fileName="foto.png"; mimeType="image/png";
    } else {
      const response=await fetch(previewVid.src);
      blob=await response.blob();
      fileName="video.mp4"; mimeType="video/mp4";
    }
    const file=new File([blob],fileName,{type:mimeType});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file]});
    } else if(navigator.share){
      const url=URL.createObjectURL(blob);
      await navigator.share({url:url});
      URL.revokeObjectURL(url);
    }
  }catch(err){console.error("Erro ao compartilhar:",err);}
};

closeBtn.onclick=()=>{preview.style.display="none";previewVid.pause();previewVid.src="";frozenFrame.style.display="none";tapPlay.style.display="none";};
document.getElementById("switch").onclick=()=>{currentFacing=(currentFacing==="environment"?"user":"environment");startCamera();};
startCamera();
</script>
</body>
</html>
