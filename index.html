<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CÃ¢mera WebGL â€“ Compartilhar ðŸ’•</title>
<style>
  body {margin:0; background:#000; overflow:hidden; height:100vh; display:flex; justify-content:center; align-items:center;}
  canvas#gl {
    width:100vw; height:100vh; background:#000; display:block; object-fit:cover;
    transform:translateZ(0);  /* ðŸ”¹ forÃ§a renderizaÃ§Ã£o via GPU */
  }
  #controls {position:absolute; bottom:50px; width:100%; display:flex; justify-content:center; align-items:center;}
  #recordButton {width:90px; height:90px; border-radius:50%; border:6px solid white; background:red; box-shadow:0 0 10px rgba(255,0,0,0.7); transition:transform .15s, box-shadow .3s; touch-action:none; cursor:pointer;}
  #recordButton:active {transform:scale(.9); box-shadow:0 0 25px rgba(255,0,0,1);}
  #photoButton {position:absolute; right:80px; bottom:85px; width:70px; height:70px; border-radius:50%; border:5px solid white; background:white; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .15s, box-shadow .3s;}
  #photoButton:active {transform:scale(.9); box-shadow:0 0 15px rgba(255,255,255,0.9);}
  #photoButton svg {width:38px; height:38px; fill:black;}
  #switch {position:absolute; top:20px; right:20px; background:transparent; border:none; width:75px; height:75px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.2s;}
  #switch svg {width:55px; height:55px; fill:white; opacity:.95; filter: drop-shadow(0 0 12px rgba(255,255,255,0.9)) drop-shadow(0 0 25px rgba(255,255,255,0.7)); animation: brilhoIntenso 2s infinite ease-in-out;}
  @keyframes brilhoIntenso {
    0%,100% {filter: drop-shadow(0 0 10px rgba(255,255,255,0.7)) drop-shadow(0 0 20px rgba(255,255,255,0.5)); opacity:0.9; transform:scale(1);}
    50% {filter: drop-shadow(0 0 25px rgba(255,255,255,1)) drop-shadow(0 0 40px rgba(255,255,255,0.9)); opacity:1; transform:scale(1.1);}
  }
  #previewContainer {display:none; position:absolute; top:0; left:0; width:100vw; height:100vh; background:#000; justify-content:center; align-items:center; z-index:1000; flex-direction:column;}
  #previewContainer img, #previewContainer video {max-width:100vw; max-height:100vh; object-fit:contain;}
  #previewActions {position:absolute; bottom:130px; display:flex; flex-direction:column; align-items:center; gap:12px;}
  .btnShare {background:#ff4da6; color:white; font-size:18px; border:none; border-radius:25px; padding:10px 30px; font-weight:bold; box-shadow:0 0 20px rgba(255,77,166,0.9); cursor:pointer; animation: shareGlow 2s infinite ease-in-out;}
  @keyframes shareGlow {0%,100% {box-shadow:0 0 20px rgba(255,77,166,0.8),0 0 40px rgba(255,77,166,0.5);} 50% {box-shadow:0 0 40px rgba(255,77,166,1),0 0 80px rgba(255,77,166,0.9);} }
  .btnClose {background:rgba(0,0,0,0.75); color:white; font-size:16px; border:1.5px solid rgba(255,255,255,0.4); border-radius:25px; padding:8px 25px; cursor:pointer; box-shadow:0 0 10px rgba(255,255,255,0.4);}
</style>
</head>
<body>
<video id="video" playsinline muted autoplay style="display:none"></video>
<canvas id="gl"></canvas>

<div id="controls">
  <button id="recordButton" title="Gravar vÃ­deo"></button>
</div>
<button id="photoButton" title="Tirar foto">
  <svg viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="3.2"></circle>
    <path d="M20 5h-3.2l-1.8-2H9L7.2 5H4C2.9 5 2 5.9 2 7v12c0 
    1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 
    14H4V7h3.05l1.83-2h6.24l1.83 2H20v12z"></path>
  </svg>
</button>

<button id="switch" title="Trocar cÃ¢mera">
  <svg viewBox="0 0 512 512">
    <path d="M256 96c-88.22 0-160 71.78-160 160H64l64 64 64-64h-32c0-70.58 
    57.42-128 128-128 31.35 0 60.02 11.48 82.41 30.4l23.18-27.08C364.94 
    107.51 312.92 96 256 96zm128 160c0 70.58-57.42 128-128 128-31.35 
    0-60.02-11.48-82.41-30.4l-23.18 27.08C147.06 404.49 199.08 416 
    256 416c88.22 0 160-71.78 160-160h32l-64-64-64 64h32z"/>
  </svg>
</button>

<div id="previewContainer">
  <img id="previewImage" style="display:none;">
  <video id="previewVideo" playsinline controls style="display:none;"></video>
  <div id="previewActions">
    <button id="shareBtn" class="btnShare">Compartilhar ðŸ’•</button>
    <button id="closeBtn" class="btnClose">Fechar</button>
  </div>
</div>

<script>
let currentFacing="environment", stream, isRecording=false, mediaRecorder, recordedChunks=[];
const v=document.getElementById("video");
const glcanvas=document.getElementById("gl");
/* ðŸ”¹ SuavizaÃ§Ã£o de textura ativada */
const gl=glcanvas.getContext("webgl",{
  preserveDrawingBuffer:true,
  antialias:true,
  alpha:false
});
const recordButton=document.getElementById("recordButton");
const photoButton=document.getElementById("photoButton");
const preview=document.getElementById("previewContainer");
const previewImg=document.getElementById("previewImage");
const previewVid=document.getElementById("previewVideo");
const shareBtn=document.getElementById("shareBtn");
const closeBtn=document.getElementById("closeBtn");

function createShader(type,src){const s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); return s;}
const vs=createShader(gl.VERTEX_SHADER,`attribute vec2 p; varying vec2 uv;
void main(){ uv=(p+1.0)/2.0; uv.y=1.0-uv.y; gl_Position=vec4(p,0,1); }`);
const fs=createShader(gl.FRAGMENT_SHADER,`precision mediump float; varying vec2 uv;
uniform sampler2D t; uniform bool flipX;
void main(){ vec2 texCoord=uv; if(flipX) texCoord.x=1.0-texCoord.x;
gl_FragColor=texture2D(t,texCoord); }`);
const prog=gl.createProgram(); gl.attachShader(prog,vs); gl.attachShader(prog,fs); gl.linkProgram(prog);
const buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);
gl.useProgram(prog);
const loc=gl.getAttribLocation(prog,"p"); gl.enableVertexAttribArray(loc);
gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
const tex=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,tex);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
gl.generateMipmap(gl.TEXTURE_2D);
gl.uniform1i(gl.getUniformLocation(prog,"t"),0);
const flipLoc=gl.getUniformLocation(prog,"flipX");

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  const constraints={audio:true, video:{facingMode:currentFacing, width:{ideal:1920}, height:{ideal:1080}}};
  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    v.srcObject=stream; await v.play();
    renderLoop();
  } catch(e) { console.error(e); }
}

function renderLoop(){
  if(v.videoWidth===0){ requestAnimationFrame(renderLoop); return;}
  glcanvas.width=innerWidth; glcanvas.height=innerHeight;
  gl.viewport(0,0,glcanvas.width,glcanvas.height);
  gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,v);
  gl.uniform1i(flipLoc, currentFacing==="user");
  gl.drawArrays(gl.TRIANGLES,0,6);
  requestAnimationFrame(renderLoop);
}

photoButton.onclick = () => {
  const data = glcanvas.toDataURL("image/png");
  previewImg.src = data;
  previewImg.style.display="block";
  previewVid.style.display="none";
  preview.style.display="flex";
};

recordButton.addEventListener("touchstart", e => { e.preventDefault(); startRec(); }, {passive:false});
recordButton.addEventListener("touchend", e => { e.preventDefault(); stopRec(); }, {passive:false});
recordButton.addEventListener("mousedown", startRec);
recordButton.addEventListener("mouseup", stopRec);

function startRec(){
  if(isRecording) return;
  recordedChunks=[];
  const mime = MediaRecorder.isTypeSupported("video/mp4") ? "video/mp4" : "video/webm";
  mediaRecorder = new MediaRecorder(glcanvas.captureStream(), { mimeType:mime });
  mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, {type:mime});
    const url = URL.createObjectURL(blob);
    previewVid.src = url;
    previewVid.style.display="block";
    previewImg.style.display="none";
    preview.style.display="flex";
  };
  mediaRecorder.start();
  isRecording=true;
}
function stopRec(){
  if(!isRecording) return;
  mediaRecorder.stop();
  isRecording=false;
}

shareBtn.onclick = async () => {
  try {
    let blob, fileName, mimeType;
    if (previewImg.style.display === "block") {
      blob = await (await fetch(previewImg.src)).blob();
      fileName = "foto.png"; mimeType = "image/png";
    } else if (previewVid.style.display === "block") {
      blob = await (await fetch(previewVid.src)).blob();
      fileName = "video.mp4"; mimeType = "video/mp4";
    }
    const file = new File([blob], fileName, { type: mimeType });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file], title: "Compartilhar ðŸ’•" });
    } else {
      await navigator.share({ title: "Compartilhar ðŸ’•", url: URL.createObjectURL(blob) });
    }
  } catch (err) {
    console.error("Erro ao compartilhar:", err);
  }
};

closeBtn.onclick = () => {
  preview.style.display="none";
  previewVid.pause();
  previewVid.src="";
};

document.getElementById("switch").onclick = () => {
  currentFacing = (currentFacing==="environment" ? "user" : "environment");
  startCamera();
};

startCamera();
</script>
</body>
</html>
